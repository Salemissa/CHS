  {% include 'navbar.html' %}
<!DOCTYPE html>
<html lang="fr">
<style>
.icon-circle {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}
.stat-card {
    transition: transform 0.15s, box-shadow 0.15s;
}
.stat-card:hover {
    transform: translateY(-4px) scale(1.03);
    box-shadow: 0 8px 32px rgba(0,123,255,0.13);
    z-index: 2;
}

/* Styles pour le message "Non trouvé" */
#noResultsRow {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px dashed #dee2e6;
    animation: fadeIn 0.3s ease-in;
}

#noResultsRow td {
    border: none !important;
}

#noResultsRow .fa-search-minus {
    opacity: 0.6;
    animation: pulse 2s infinite;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Styles pour la pagination */
.pagination {
    margin-bottom: 0;
}

.pagination .page-link {
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 0.75rem 1rem;
    margin: 0 2px;
    border-radius: 0.375rem;
    transition: all 0.15s ease-in-out;
    font-weight: 500;
}

.pagination .page-link:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
    color: #495057;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
    box-shadow: 0 2px 4px rgba(0,123,255,0.25);
}

.pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
    cursor: not-allowed;
}

.pagination .page-link i {
    font-size: 0.875rem;
}

/* Animation pour les boutons de pagination */
.pagination .page-item {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<!-- Statistiques modernisées -->
<div class="container">
<div class="row mb-4 g-4">
    <div class="col-md-3">
        <div class="card stat-card primary shadow h-100 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">Score/Moyenne</h6>
                        <h3 class="text-primary fw-bold mb-0">{{ score_moyenne }}</h3>
                        <small class="text-secondary">Moyenne des scores</small>
                    </div>
                    <div class="icon-circle bg-primary bg-opacity-10">
                        <i class="fas fa-user fa-2x text-primary"></i><i class="fa-solid fa-ranking-star"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card primary shadow h-100 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">Indigents</h6>
                        <h3 class="text-danger fw-bold mb-0">{{ total_indigents }}</h3>
                        <small class="text-secondary">Nombre des indigents</small>
                    </div>
                    <div class="icon-circle bg-danger bg-opacity-10">
                        <i class="fas fa-user fa-2x text-danger"></i><i class="fa-solid fa-ranking-star"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card primary shadow h-100 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">Non Indigents</h6>
                        <h3 class="text-primary fw-bold mb-0">{{ total_non_indigents }}</h3>
                        <small class="text-secondary">Nombre des non indigents</small>
                    </div>
                    <div class="icon-circle bg-primary bg-opacity-10">
                        <i class="fas fa-user-tie fa-2x text-primary"></i><i class="fa-solid fa-ranking-star"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="col-md-3">
        <div class="card stat-card dark shadow h-100 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">Taux d’indigence</h6>
                        <h3 class="text-dark fw-bold mb-0">{{ taux_indigence }}</h3>
                        <small class="text-secondary">Taux d’indigence</small>
                    </div>
                    <div class="icon-circle bg-success bg-opacity-10">
                        <i class="fas fa-percent fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% comment %} <div class="col-md-3">
        <div class="card stat-card success shadow h-100 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">Total indigents</h6>
                        <h3 class="text-success fw-bold mb-0">{{ total_indigents }}</h3>
                        <small class="text-secondary">Tous les indigents</small>
                    </div>
                    <div class="icon-circle bg-dark bg-opacity-10">
                        <i class="fas fa-check-circle fa-2x text-dark"></i>
                    </div>
                </div>
            </div>
        </div>
    </div> {% endcomment %}
    <div class="col-md-12">
        <div class="card stat-card warning shadow h-100 border-0">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-muted mb-2">Total  dossiers</h6>
                        <h3 class="text-warning fw-bold mb-0">{{ total_dossiers }}</h3>
                        <small class="text-secondary">Tous les dossiers</small>
                    </div>
                    <div class="icon-circle bg-warning bg-opacity-10">
                        <i class="fas fa-list fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-end gap-2">

        <a href="{% url 'create_chs' %}" class="btn btn-primary btn-lg" id="ordreMissionBtn" data-url="">
           <i class="fas fa-plus"></i> Créer un nouvelle dossier
        </a>
      
         <a href="" class="btn btn-outline-warning btn-lg" title="Rechercher un dossier">
            <i class="fa fa-search" aria-hidden="true"></i> Rechercher un dossier
        </a>
      
      
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-3">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-light border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control form-control-lg border-start-0" id="searchMissionInput" 
                           placeholder="Rechercher par  numero...">
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Toutes les dossiers</h5>
            
            </div>
            <div class="card-body">
                {% if chs_page %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
    <tr>
        <th>Numéro dossier</th>
        <th>Nom et prénom</th>
        <th>NNI</th>
        <th>Date</th>
        <th>Action</th>
       
    </tr>
</thead>
<tbody>

           {% for dossier in chs_page %}
           <tr>
               <td>{{ dossier.num_dossier }}</td>
               <td>{{ dossier.nom }}</td>
               <td>{{ dossier.nni }}</td>
               <td>{{ dossier.date_jour }}</td>
               <td>
              
                <a href="" class="btn btn-sm btn-outline-info" title="Voir plus">
                    <i class="fas fa-eye"></i>
                </a>

               </td>
           </tr>
           {% endfor %}
</tbody>
                    </table>
                </div>
                    <nav aria-label="Pagination des dossiers" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if chs_page.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="Première page">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ chs_page.previous_page_number }}" aria-label="Page précédente">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-hidden="true"><i class="fas fa-angle-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link" aria-hidden="true"><i class="fas fa-angle-left"></i></span>
                        </li>
                        {% endif %}

                        {% for num in chs_page.paginator.page_range %}
                        {% if num == chs_page.number %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                        {% elif num >= chs_page.number|add:'-2' and num <= chs_page.number|add:'2' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                        {% endif %}
                        {% endfor %}

                        {% if chs_page.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ chs_page.next_page_number }}" aria-label="Page suivante">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ chs_page.paginator.num_pages }}" aria-label="Dernière page">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link" aria-hidden="true"><i class="fas fa-angle-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link" aria-hidden="true"><i class="fas fa-angle-double-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% else %}
                <p class="text-muted">Aucun dossier disponible.</p>
                {% endif %}
</div>

            </div>
        </div>
    </div>
  

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const searchInput = document.getElementById('searchMissionInput');
if (searchInput) {
  searchInput.addEventListener('input', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('table tbody tr');
    let visibleRows = 0;
    
    rows.forEach(row => {
      const numeroCell = row.querySelector('td'); // Première colonne = numéro
      const numero = numeroCell ? numeroCell.textContent.toLowerCase() : '';
      const isVisible = numero.includes(filter);
      row.style.display = isVisible ? '' : 'none';
      if (isVisible) visibleRows++;
    });
    
    // Afficher un message si aucun résultat
    const noResultsRow = document.getElementById('noResultsRow');
    if (visibleRows === 0) {
      if (!noResultsRow) {
        const tableBody = document.querySelector('table tbody');
        const newRow = document.createElement('tr');
        newRow.id = 'noResultsRow';
        newRow.innerHTML = `
          <td colspan="5" class="text-center py-5">
            <i class="fas fa-search-minus fa-3x mb-3"></i>
            <h5>Aucun dossier trouvé</h5>
            <p class="text-muted">Essayez une autre recherche.</p>
          </td>
        `;
        tableBody.appendChild(newRow);
      }
    } else if (noResultsRow) {
      noResultsRow.remove();
    }
  });
}

// Graphique amélioré pour les indigents par wilaya
const wilayaDataRaw = '{{ indigents_par_wilaya|escapejs }}';
const wilayaData = wilayaDataRaw ? JSON.parse(wilayaDataRaw) : [];

if (wilayaData.length > 0) {
  const ctx = document.getElementById('indigentsWilayaChart');
  if (ctx) {
    const labels = wilayaData.map(item => item.wilaya);
    const data = wilayaData.map(item => item.total);

    // Générer des couleurs variées
    const colors = [
      'rgba(255, 99, 132, 0.7)',
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 205, 86, 0.7)',
      'rgba(75, 192, 192, 0.7)',
      'rgba(153, 102, 255, 0.7)',
      'rgba(255, 159, 64, 0.7)',
      'rgba(199, 199, 199, 0.7)',
      'rgba(83, 102, 255, 0.7)',
      'rgba(255, 102, 255, 0.7)',
      'rgba(102, 255, 102, 0.7)'
    ];
    const borderColors = colors.map(color => color.replace('0.7', '1'));

    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Nombre d\'indigents',
          data: data,
          backgroundColor: colors.slice(0, data.length),
          borderColor: borderColors.slice(0, data.length),
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
          hoverBackgroundColor: colors.slice(0, data.length).map(color => color.replace('0.7', '0.9')),
          hoverBorderColor: borderColors.slice(0, data.length)
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 2000,
          easing: 'easeOutBounce'
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: 'white',
            bodyColor: 'white',
            callbacks: {
              title: function(tooltipItems) {
                return `Wilaya: ${tooltipItems[0].label}`;
              },
              label: function(context) {
                const total = context.parsed.y;
                const percentage = ((total / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                return `${total} indigent(s) (${percentage}%)`;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 45,
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              font: {
                size: 12
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          }
        },
        onClick: function(event, elements) {
          if (elements.length > 0) {
            const index = elements[0].index;
            const selectedWilaya = labels[index];
            const count = data[index];
            alert(`Détails pour ${selectedWilaya}:\nNombre d'indigents: ${count}\n\n(Cette fonctionnalité peut être étendue pour afficher plus de détails.)`);
          }
        }
      }
    });

    // Mettre à jour le résumé
    const summaryDiv = document.getElementById('wilayaSummary');
    if (summaryDiv) {
      summaryDiv.innerHTML = '';
      wilayaData.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-group-item d-flex justify-content-between align-items-center';
        itemDiv.innerHTML = `
          <span><span class="badge me-2" style="background-color: ${colors[index]}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>${item.wilaya}</span>
          <span class="badge bg-secondary">${item.total}</span>
        `;
        summaryDiv.appendChild(itemDiv);
      });

      // Ajouter le total
      const totalDiv = document.createElement('div');
      totalDiv.className = 'list-group-item d-flex justify-content-between align-items-center fw-bold';
      totalDiv.innerHTML = `
        <span>Total indigents</span>
        <span class="badge bg-primary">${data.reduce((a, b) => a + b, 0)}</span>
      `;
      summaryDiv.appendChild(totalDiv);
    }
  }
}
</script>
{% endblock extra_js %}
